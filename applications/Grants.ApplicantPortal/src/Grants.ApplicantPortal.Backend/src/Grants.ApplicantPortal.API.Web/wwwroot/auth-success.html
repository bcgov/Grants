<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keycloak Token - Success</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 20px 0;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .success-icon {
            font-size: 48px;
            color: #28a745;
            margin-bottom: 10px;
        }
        h1 {
            color: #28a745;
            margin: 0;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 16px;
        }
        .token-section {
            margin: 20px 0;
        }
        .token-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .token-value {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 12px;
            word-break: break-all;
            line-height: 1.5;
            position: relative;
            max-height: 150px;
            overflow-y: auto;
        }
        .copy-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
        }
        .copy-btn:hover {
            background: #0056b3;
        }
        .copy-btn.copied {
            background: #28a745;
        }
        .user-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .user-info h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        .user-detail {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 4px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .user-detail:last-child {
            border-bottom: none;
        }
        .user-label {
            font-weight: 500;
            color: #666;
        }
        .user-value {
            color: #333;
            font-family: monospace;
        }
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            padding: 16px;
            margin: 20px 0;
        }
        .instructions h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        .instructions p {
            margin: 8px 0;
            color: #333;
        }
        .code-example {
            background: #263238;
            color: #fff;
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .close-notice {
            text-align: center;
            padding: 20px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            color: #155724;
            margin-top: 20px;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="success-icon">??</div>
            <h1>Authentication Successful!</h1>
            <p class="subtitle">Your JWT token has been generated successfully</p>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading token information...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Token sections will be populated by JavaScript -->
        </div>

        <div class="close-notice">
            <strong>? You can now close this window</strong><br>
            Your token is ready to use for API testing
        </div>
    </div>

    <script>
        // Function to copy text to clipboard
        async function copyToClipboard(text, buttonElement) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'Copied!';
                buttonElement.classList.add('copied');
                
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
                
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    buttonElement.textContent = 'Copied!';
                    buttonElement.classList.add('copied');
                    
                    setTimeout(() => {
                        buttonElement.textContent = 'Copy';
                        buttonElement.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('Fallback copy failed: ', err);
                }
                
                document.body.removeChild(textArea);
            }
        }

        // Function to create a token section
        function createTokenSection(label, value, emoji = '??') {
            if (!value) return '';
            
            const tokenId = label.toLowerCase().replace(/\s+/g, '-');
            return `
                <div class="token-section">
                    <div class="token-label">
                        <span>${emoji} ${label}</span>
                        <button class="copy-btn" onclick="copyToClipboard('${value}', this)">Copy</button>
                    </div>
                    <div class="token-value" id="${tokenId}">${value}</div>
                </div>
            `;
        }

        // Function to create user info section
        function createUserInfoSection(userInfo) {
            if (!userInfo) return '';
            
            return `
                <div class="user-info">
                    <h3>?? User Information</h3>
                    ${userInfo.name ? `<div class="user-detail"><span class="user-label">Name:</span><span class="user-value">${userInfo.name}</span></div>` : ''}
                    ${userInfo.preferredUsername ? `<div class="user-detail"><span class="user-label">Username:</span><span class="user-value">${userInfo.preferredUsername}</span></div>` : ''}
                    ${userInfo.email ? `<div class="user-detail"><span class="user-label">Email:</span><span class="user-value">${userInfo.email}</span></div>` : ''}
                    ${userInfo.sub ? `<div class="user-detail"><span class="user-label">Subject ID:</span><span class="user-value">${userInfo.sub}</span></div>` : ''}
                    ${typeof userInfo.emailVerified !== 'undefined' ? `<div class="user-detail"><span class="user-label">Email Verified:</span><span class="user-value">${userInfo.emailVerified ? '? Yes' : '? No'}</span></div>` : ''}
                </div>
            `;
        }

        // Function to display error
        function displayError(errorData) {
            const errorHtml = `
                <div class="error">
                    <h3>? Authentication Error</h3>
                    <p><strong>Error:</strong> ${errorData.error}</p>
                    ${errorData.error_description ? `<p><strong>Description:</strong> ${errorData.error_description}</p>` : ''}
                </div>
            `;
            document.getElementById('content').innerHTML = errorHtml;
            document.getElementById('content').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Function to get query parameters
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                state: params.get('state'),
                error: params.get('error'),
                error_description: params.get('error_description')
            };
        }

        // Function to load token data
        async function loadTokenData() {
            const params = getQueryParams();
            
            // Check for OAuth errors
            if (params.error) {
                displayError(params);
                return;
            }

            // If we have a code, the callback should have processed it
            if (params.code) {
                try {
                    // Make a request to our callback endpoint to get the token data
                    // The callback endpoint should automatically handle the token exchange
                    const response = await fetch(`/auth/callback?code=${params.code}&state=${params.state || ''}`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.success) {
                            displayTokenData(data);
                        } else {
                            throw new Error(data.message || 'Token exchange failed');
                        }
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error loading token data:', error);
                    
                    // Fallback: show the authorization code
                    const fallbackHtml = `
                        <div class="token-section">
                            <div class="token-label">
                                <span>?? Authorization Code</span>
                                <button class="copy-btn" onclick="copyToClipboard('${params.code}', this)">Copy</button>
                            </div>
                            <div class="token-value">${params.code}</div>
                        </div>
                        <div class="instructions">
                            <h3>?? Manual Token Exchange Required</h3>
                            <p>The automatic token exchange failed. You can use this authorization code manually:</p>
                            <div class="code-example">curl -X POST "${window.location.origin}/auth/callback" \\<br>
  -H "Content-Type: application/x-www-form-urlencoded" \\<br>
  -d "code=${params.code}"</div>
                            <p><strong>Error:</strong> ${error.message}</p>
                        </div>
                    `;
                    
                    document.getElementById('content').innerHTML = fallbackHtml;
                }
            } else {
                // No code parameter, show error
                const noCodeHtml = `
                    <div class="error">
                        <h3>? No Authorization Code</h3>
                        <p>No authorization code was received from the authentication server.</p>
                        <p>Please try the authentication process again.</p>
                    </div>
                `;
                document.getElementById('content').innerHTML = noCodeHtml;
            }
            
            document.getElementById('content').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Function to display token data
        function displayTokenData(data) {
            console.log('Token data received:', data);
            
            const expirationTime = new Date(Date.now() + (data.expiresIn * 1000));
            const expirationString = expirationTime.toLocaleString();
            
            const html = `
                ${createTokenSection('Access Token', data.accessToken, '???')}
                ${createTokenSection('Refresh Token', data.refreshToken, '??')}
                ${data.idToken ? createTokenSection('ID Token', data.idToken, '??') : ''}
                
                <div class="token-section">
                    <div class="token-label">? Token Details</div>
                    <div class="user-info">
                        <div class="user-detail">
                            <span class="user-label">Token Type:</span>
                            <span class="user-value">${data.tokenType || 'Bearer'}</span>
                        </div>
                        <div class="user-detail">
                            <span class="user-label">Expires In:</span>
                            <span class="user-value">${data.expiresIn} seconds (${Math.round(data.expiresIn / 60)} minutes)</span>
                        </div>
                        <div class="user-detail">
                            <span class="user-label">Expires At:</span>
                            <span class="user-value">${expirationString}</span>
                        </div>
                        ${data.scope ? `<div class="user-detail"><span class="user-label">Scope:</span><span class="user-value">${data.scope}</span></div>` : ''}
                    </div>
                </div>

                ${createUserInfoSection(data.userInfo)}

                <div class="instructions">
                    <h3>?? Test Your API</h3>
                    <p>Use this token to test your API endpoints:</p>
                    <div class="code-example">curl -H "Authorization: Bearer ${data.accessToken}" \\<br>
     ${window.location.origin}/Auth/userinfo</div>
                    
                    <p>Or set it as an environment variable in PowerShell:</p>
                    <div class="code-example">$env:KEYCLOAK_TOKEN = "${data.accessToken}"</div>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }

        // Initialize the page when DOM is loaded
        function initializePage() {
            // Check if we have pre-injected data from the server
            if (typeof tokenData !== 'undefined' && tokenData) {
                console.log('Using pre-injected token data');
                displayTokenData(tokenData);
                document.getElementById('content').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            } else if (typeof errorData !== 'undefined' && errorData) {
                console.log('Using pre-injected error data');
                displayError(errorData);
            } else {
                console.log('Loading token data from query parameters');
                loadTokenData();
            }
        }

        // Load token data when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>